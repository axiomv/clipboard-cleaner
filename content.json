document.addEventListener('copy', (e) => {
  const selection = window.getSelection();
  if (!selection || selection.isCollapsed) return;

  const text = selection.toString();
  const cleanText = sanitizeText(text);

  const html = getSanitizedHTML(selection);
  const cleanHtml = sanitizeHtml(html);

  e.preventDefault();
  e.clipboardData.setData('text/plain', cleanText);
  e.clipboardData.setData('text/html', cleanHtml);
});

function sanitizeText(text) {
  // Strip tracking junk like "Copied from ..."
  return text.replace(/(\n)?Copied from .*/gi, '').trim();
}

function getSanitizedHTML(selection) {
  const range = selection.getRangeAt(0);
  const container = document.createElement('div');
  container.appendChild(range.cloneContents());
  return container.innerHTML;
}

function sanitizeHtml(html) {
  const div = document.createElement('div');
  div.innerHTML = html;

  // Remove style/class attributes and certain tags
  div.querySelectorAll('[style], [class], script, iframe').forEach(el => el.remove());

  // Optional: remove all <a> tags
  div.querySelectorAll('a').forEach(a => {
    const span = document.createElement('span');
    span.textContent = a.textContent;
    a.replaceWith(span);
  });

  return div.innerHTML.trim();
}
